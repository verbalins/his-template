%%
%% Copyright 2016-2023 by Simon Lidberg <simon.lidberg@his.se>
%% Based on hiscover.cls by Thomas Fischer <thomas.fischer@his.se>
%% 
%% This file has been released under the following license:
%% Creative Commons Attribution-Share Alike 4.0 Unported
%% (CC-BY-SA 4.0)
%%
%% hiscover.sty is a LaTeX package for dissertation/licentiate report covers
%%

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{hiscover}[2022/08/16 University of Skovde Thesis Cover class by Thomas Fischer, modified by Simon Lidberg]

\RequirePackage{etoolbox}
\RequirePackage{xstring}

\RequirePackage[absolute]{textpos}
\setlength{\TPHorizModule }{1mm}
\setlength{\TPVertModule }{1mm}

\setlength{\parskip}{0pt}
\setlength{\parindent}{0pt}

\definecolor{oxid}{RGB}{234,120,25}

\sodef\bookspinespacing{}{.1em}{8pt}{0pt}% TODO adjust last two parameters ('inner space' and 'outer space')

%\newcommand{\}{} % CHANGE: Removed this, gave error

% CHANGE Function to adapt the font size of the title to fit the allotted space, 25pt size default
\usepackage{environ}% http://ctan.org/pkg/environ
\newdimen\fontdim
\newdimen\upperfontdim
\newdimen\lowerfontdim
\newif\ifmoreiterations
\fontdim25pt % CHANGE 

\newbox\trialbox
\newbox\linebox
\global\newcount\maxbad
\newcount\linebad
\newcount\currenthbadness

\NewEnviron{fitbox}[2]{% \begin{fitbox}{<width>}{<height>} stuff \end{fitbox}
    % Store environment body
    \def\stuff{%
        \BODY%
    }%
    % prepare badness box
    \def\badnessbox{%
        \global\maxbad=0\relax%
        \currenthbadness=\hbadness% save old \hbadness
        \hbadness=10000000\relax% make sure, TeX reports overfull boxes
        \message{Starting measureline recursion with width #1^^J}%
        \setbox\trialbox=\vbox{%
            \hsize#1\relax%
            \fontsize{\fontdim}{1.2\fontdim}%
            \selectfont%
            \stuff\par%
            \measurelines% start recursion
        }%
%       \noindent\usebox\trialbox\par
        \hbadness=\currenthbadness% restore old \hbadness
    }%
    % prepare recursion to measure line badness
    \def\measurelines{%
        \message{Iteration of measurelines^^J}%
        \begingroup%
            \setbox\linebox=\lastbox% get the last line
            \setbox0=\hbox to \hsize{\unhcopy\linebox}% put the last line into box0 to provoke badness calculation
            \linebad=\the\badness\relax% \badness now reflects the last typeset box, i.e. box0
            \message{Badness: \the\badness\space\the\linebad\space with max \the\maxbad\space at Fontsize: \the\fontdim\space^^J}%
            \ifnum\linebad>\maxbad% store the maximum badness
                \global\maxbad=\linebad% Uncomment this line to ignore overfull hboxes!
            \fi%
            \ifvoid% end of recursion
                \linebox%
            \else%
                \unskip\unpenalty\measurelines% do the recursion
                \ifhmode%
                    \newline%
                \fi%
                \noindent\box\linebox% do the output
            \fi%
        \endgroup%
    }%
    % Prepare measurement box
    \def\buildbox{%
        \badnessbox% measure badness
        \setbox0\vbox{% measure height
            \hbox{%
                \fontsize{\fontdim}{1.2\fontdim}%
                \selectfont%
                \minipage{#1}%
                    \vbox{%
                        \stuff\par%
                    }%
                \endminipage%
            }%
        }%
        \message{Measured badness: \the\maxbad\space at Fontsize: \the\fontdim\space^^J}%
        \dimen@\ht0
        \advance\dimen@\dp0
        \message{Measured box height: \the\dimen@\space^^J}%
    }%
    \def\shrinkheight{%
        \loop
            \fontdim.5\fontdim % Reduce font size by half
            \buildbox
            \message{Shrinking, new box height: \the\dimen@\space at Fontsize: \the\fontdim\space^^J}%
        \ifdim\dimen@>#2 \repeat
        \lowerfontdim\fontdim
        \upperfontdim2\fontdim
        \fontdim1.5\fontdim
    }%
    \def\shrinkwidth{%
        \loop
            \fontdim.5\fontdim % Reduce font size by half
            \buildbox
        \ifnum\maxbad>10000 \repeat
        \lowerfontdim\fontdim
        \upperfontdim2\fontdim
        \fontdim1.5\fontdim
    }%
    \def\growheight{%
        \loop
            \fontdim2\fontdim % Double font size
            \buildbox
            \message{Growing, new box height: \the\dimen@\space at Fontsize: \the\fontdim\space^^J}%
        \ifdim\dimen@<#2 \repeat
        \upperfontdim\fontdim
        \lowerfontdim.5\fontdim
        \fontdim.75\fontdim
    }%
    \buildbox
    % Compute upper and lower bounds
    \ifdim\dimen@>#2
        \message{Need to shrink box height: \the\dimen@\space^^J}%
        \shrinkheight
    \else
        \message{Need to grow box height: \the\dimen@\space to target: #2^^J}%
        \growheight
    \fi
    \message{Max font: \the\upperfontdim\space^^J}%
    \message{Min font: \the\lowerfontdim\space^^J}%
    % Potentially further reduce bounds for overfull box
    \ifnum\maxbad>10000
        \shrinkwidth
    \fi 
    \message{Max font adjusted: \the\upperfontdim\space^^J}%
    \message{Min font adjusted: \the\lowerfontdim\space^^J}%
    % Now try to find the optimum height and width
    \loop
        \buildbox
        \message{Height: \the\dimen@\space^^J}%
        \ifdim\dimen@>#2
            \moreiterationstrue
            \upperfontdim\fontdim
            \advance\fontdim\lowerfontdim
            \fontdim.5\fontdim
        \else
            \ifnum\maxbad>10000
                \moreiterationstrue
                \upperfontdim\fontdim
                \advance\fontdim\lowerfontdim
                \fontdim.5\fontdim
            \else
                \advance\dimen@-#2
                \ifdim\dimen@<10pt
                    \lowerfontdim\fontdim
                    \advance\fontdim\upperfontdim
                    \fontdim.5\fontdim
                    \dimen@\upperfontdim
                    \advance\dimen@-\lowerfontdim
                    \ifdim\dimen@<.2pt
                        \moreiterationsfalse
                    \else
                        \moreiterationstrue
                    \fi
                \else
                    \moreiterationsfalse
                \fi
            \fi
        \fi
    \ifmoreiterations \repeat
    \message{Selected font: \the\fontdim\space^^J}%
    \fontarial{\fontdim}{1.2\fontdim}% CHANGE Set correct font
    \vbox to #2{\box0\hbox{}}% Typeset content
}%

\newcommand{\cover}[2]{%
\internalcoverpage{#1}%
\isdissertation{
  \eject \pdfpagewidth 198mm \pdfpageheight 250mm% Set paper size to 198mm x 250mm
  \newpage%
  \internalbookspine
  \internallastpage{#2}%
}{%
  \newpage
}%
}

\newcommand{\internalcoverpage}[1]{%
\begingroup%
\vphantom{A}% problems with completely empty pages ...
\begin{textblock}{176}(0,0)%
\begin{tikzpicture}[inner sep=0pt]%
% background inamge in rubin/purple using the laurel branch
\ifthenelse{\equal{\@publicationtype}{dissertation}}{% if dissertation ...
\node[anchor=south west](backgroundimage) at (0mm,0mm) {\includegraphics[width=176mm,height=250mm,keepaspectratio]{logos/laurelbranch-rubin}};%
}{%
\ifthenelse{\equal{\@publicationtype}{licentiate}}{% if licentiate ...
\node[anchor=south west](backgroundimage) at (0mm,0mm) {\includegraphics[width=176mm,height=250mm,keepaspectratio]{logos/laurelbranch-grafit}};%
}{%
% no background image for 'thesisproposal' or 'researchproposal'
}% end of if licentiate
}% end of if dissertation
\end{tikzpicture}%
\end{textblock}%

\isdissertation{
  \begin{textblock}{138}(18,21) % Doctoral / licentiate dissertation
}{%
  \begin{textblock}{176}(18,21) % Research Proposal / Thesis Proposal
}
% Coat of Arms on page's top left side
%\includegraphics[height=35mm,width=35mm,keepaspectratio]{\@coatofarmsimagefilename}%
\includegraphics[height=35mm,width=35mm,keepaspectratio]{logos/HiSCoatOfArms-white-\languagename}%
\vspace*{3cm plus 5mm minus 5mm}%
\par%
%
% user content comes here
\ifthenelse{\equal{#1}{}}
{\vspace*{8cm}} % Show empty space if image not supplied
{
\IfSubStr{includegraphics}{#1}% Check if the user supplied an includegraphics command
{#1}%
{\includegraphics[width=\textwidth,height=8cm]{#1}}%
}
% after user content:
\par%
\vspace*{5mm}\vfil%
%
\begin{minipage}[t]{\linewidth}%
\RaggedRight%
\color{white}%
\begingroup\fontgeorgia{13.5}{13.5}%
\MakeUppercase{\coverpagesubjectspacing{\@publicationtypelong}}
\par\endgroup%
\vspace*{4mm}%
\begingroup\fontarial{25}{25}
\begin{fitbox}{\linewidth}{3cm} % CHANGE Include the new function here to constrain the title
  \flushleft\MakeUppercase{\coverpagetitlespacing{\@title}}% CHANGE Make sure to disable hyphenation
\end{fitbox}%
\par\endgroup

\vspace*{4mm}%

% CHANGE Check if subtitle is defined in metadata.tex
% If defined, show it with the same command as the title
% Else, just skip with the same amount of space. This gives the author and subject a fixed position
\ifthenelse{\equal{\@subtitleUC}{~}}{%
    \vspace*{5mm}%
}{%
    \begingroup\fontarial{14.5}{14.5}%
    \begin{fitbox}{\linewidth}{5mm} % CHANGE Include the new function here to constrain the subtitle
    \@subtitle
    \end{fitbox}%
    \par\endgroup%
}%
    
\vspace*{4mm}%

\begingroup\fontarial{14.5}{14.5}\color{oxid}\MakeUppercase{\@author}\par\endgroup%

\vspace*{1mm}%

\begingroup\fontgeorgia{12}{12}\textit{\@subject}\par\endgroup%
\end{minipage}%
\end{textblock}%
\endgroup%
}



\newcommand{\internalbookspine}{
\vphantom{A}% problems with completely empty pages ...
\begin{textblock}{22}(176,20)%
\centering%
\begin{tikzpicture}[inner sep=0pt]%
\node[rotate=-90,color=white,anchor=west](author) {%
    \begingroup\color{white}\fontarial{8.5}{8.5}%
    \textbf{\color{oxid}\bookspinespacing{\MakeUppercase{\@author}}}%
    \par\endgroup
};
\node[rotate=-90,below=3mm of author.east,anchor=west,color=white,align=left](title) {%
    \begingroup\color{white}\fontarial{8.5}{8.5}%
    \bookspinespacing{\MakeUppercase{\@title}}%
    \par\endgroup
};
\node[rotate=-90,below=3mm of title.east,anchor=west,color=white](year) {%
    \begingroup\color{white}\fontarial{8.5}{8.5}%
    \@year%
    \par\endgroup
};
\end{tikzpicture}%
\par%
\end{textblock}%
}



\newcommand{\internallastpage}[1]{%
\begingroup%
\vphantom{A}% problems with completely empty pages ...
\isdissertation{
  \begin{textblock}{88}(50,50) % Doctoral / licentiate dissertation
}{%
  \begin{textblock}{176}(50,50) % Research Proposal / Thesis Proposal
}
\begin{tikzpicture}[inner sep=0mm]%
\color{white}% use white text color due to dark purple background


% Photo
\isdissertation{
    \node[minimum width=31.05mm,minimum height=37.25mm](photobg){%
    };% end of \node(photobg)
}{%
    \node[minimum width=35.05mm,minimum height=41.25mm](photobg){%
    };% end of \node(photobg)
}
\node[left=0mm of photobg.south west,anchor=south west](photo){%
\isdissertation{
    \IfSubStr{includegraphics}{#1}%
    {#1}%
    {\includegraphics[height=37.25mm,width=31.05mm,keepaspectratio]{#1}}
}{%
    \IfSubStr{includegraphics}{#1}%
    {#1}%
    {\includegraphics[height=41.25mm,width=35.05mm,keepaspectratio]{#1}}%
}
};% end of \node(photo)


% Name
\node[right=4mm of photobg.south east,anchor=south west,text width=53.75mm](name){%
\isdissertation{
    \begingroup\fontarial{10}{10}\MakeUppercase{\@author}\par\endgroup%
}{
    \begingroup\fontarial{14.5}{14.5}\MakeUppercase{\@author}\par\endgroup%
}
};% end of \node(name)


% User content (abstract)
\node[below=5mm of photobg.south west,anchor=north west,text width=88 mm,text justified](abstract){%
\begingroup\fontsize{12}{13}%
% user content comes here
% CHANGE Check for empty parameter here. If empty, use the thesissummary, otherwise use nothing.
\@thesissummary
% after user content:
\par\endgroup%
};% end of \node(abstract)


% If performed within a collaboration
\iscollaboration{% only if collaboration partner is defined ...
% Horizontal white line
\draw[line width=1pt,white]([yshift=-3mm]abstract.south west)--([yshift=-3mm]abstract.south east);
% Collaboration text and logo
\node[below=12mm of abstract.south west,anchor=north west,text width=88mm,align=flush center](collaborationlabel){%
\begingroup\fontarial{7}{7.5}\MakeUppercase{In collaboration with}\par\endgroup%
};% end of \node(collaborationlabel)
\node[below=3mm of collaborationlabel](collaborationlogo){%
\includegraphics[width=27.5mm,height=27.5mm,keepaspectratio]{\@partnercompanylogo}%
};% end of \node(collaborationlogo)
}{}% end of "only if collaboration partner is defined ..."


% Only include ISBN and dissertation number for doctorate and licentiate
\isdissertation{
  % ISBN and Dissertation Number
  \node[text width=88mm,align=flush center,below=169mm of photo.north west,anchor=north west](number) {%
  \begingroup\fontarial{8.5}{11}%
  ISBN \@isbn\\%
  Dissertation Series, No.~\@seriesnumber~(\@year)%
  \par\endgroup%
  };% end of \node(number)
}{}%
\end{tikzpicture}%
\end{textblock}%
\endgroup%
\clearpage
}
