%%
%% Copyright 2013-2018 by Thomas Fischer <thomas.fischer@his.se>
%%
%% This file has been released under the following license:
%% Creative Commons Attribution-Share Alike 4.0 Unported
%% (CC-BY-SA 4.0)
%%

\NeedsTeXFormat{LaTeX2e}

\ProvidesPackage{hisownpublications}[2018/03/07 HiS Doctoral Candidate's Own Publications]

\RequirePackage{hisbibliography}
\RequirePackage{pdfpages}
\RequirePackage{biblatex}
\RequirePackage{geometry}
\RequirePackage{xparse}

\newcounter{ownpublicationsenumi}
\setcounter{ownpublicationsenumi}{0}

%% In theory, using \enumerate and \endenumerate should work,
%% but there are some compilation issues with the default
%% implementation. Using this one instead:
\def\enumerate{\ifnum \@enumdepth >3 \@toodeep\else
      \advance\@enumdepth \@ne
      \edef\@enumctr{enum\romannumeral\the\@enumdepth}\list
      {\csname label\@enumctr\endcsname}{\usecounter
        {\@enumctr}\itemsep 0pt\parsep 0pt
         \def\makelabel##1{\hss\llap{##1}}}\fi}
\let\endenumerate =\endlist


\defbibenvironment{ownpublicationsbibenvironment}%
{\enumerate\setcounter{enumi}{\value{ownpublicationsenumi}}}%
{\setcounter{ownpublicationsenumi}{\value{enumi}}\endenumerate}%
{\item}

\DeclareBibliographyCategory{ownpublicationshighrelevance}
\DeclareBibliographyCategory{ownpublicationslowrelevance}
\DeclareBibliographyCategory{ownpublications}

\newenvironment{ownpublications}{%
\isdissertation{\cleardoublepage}{\clearpage}
\pdfbookmark[section]{Publications}{publications} % CHANGE To include an entry in the bookmarks section of the PDF
\chapter*{Publications}%
\sloppy
%\phantomsection
}{%
%\clearpage%
\fussy
\setcounter{ownpublicationsenumi}{0}%
}

\newcommand{\highrelevancepublications}[1]{%
\begin{refcontext}[sorting=none]
\addtocategory{ownpublicationshighrelevance}{#1}\nocite{#1}
\printbibliography[heading=subbibliography,title=Publications with High Relevance,env=ownpublicationsbibenvironment,category=ownpublicationshighrelevance]
\end{refcontext}
}

\newcommand{\lowrelevancepublications}[1]{%
\begin{refcontext}[sorting=none]
\addtocategory{ownpublicationslowrelevance}{#1}\nocite{#1}
\printbibliography[heading=subbibliography,title=Publications with Low Relevance,env=ownpublicationsbibenvironment,category=ownpublicationslowrelevance]
\end{refcontext}
}

\newcommand{\authorspublications}[1]{%
\begin{refcontext}[sorting=none]
\addtocategory{ownpublications}{#1}\nocite{#1}
\printbibliography[heading=none,env=ownpublicationsbibenvironment,category=ownpublications]
\end{refcontext}
}

\newcommand{\authorspublication}[2][]{%
\stepcounter{ownpublicationsenumi}%
\subsection*{Paper \Roman{ownpublicationsenumi}}%
\fullcite{#2}%
\ifthenelse{\equal{#1}{}}{}{\par\textit{Author's contribution}: #1}% print optional author's contributions
}

% Retrieving a publication's title, without quotation marks or any other 'candy'.
% Title can be retrieved 'verbatim' (as it is) or in uppercase.
\DeclareFieldFormat{verbatim}{#1}
\DeclareFieldFormat{uppercase}{\MakeUppercase{#1}}
%\DeclareFieldFormat{titlecase}{\MakeLowercase{#1}}
%\DeclareCiteCommand{\citetitlecase}{}{\printfield[titlecase]{title}}{}{}
\DeclareCiteCommand{\citetitleverbatim}{}{\printfield[verbatim]{title}}{}{}
\DeclareCiteCommand{\citetitleuppercase}{}{\printfield[uppercase]{title}}{}{}

% CHANGE to incorporate additional optional arguments to this function.
% First optional argument is optional arguments for includepdf, defaults to scale=.85,clip=true,pages=-. #1
% First mandatory argument is a path to the pdf file. #2
% Second mandatory argument is the reference code to the article. #3
% Second optional argument is the prefix to the full citation. #4
% Third optional argument is the suffix to the full citation. #5
\NewDocumentCommand \fullarticle {O{scale=.85,clip=true,pages=-} m m O{} O{}}{%
\stepcounter{ownpublicationsenumi}
\phantomsection
\addcontentsline{toc}{section}{\texorpdfstring{Paper~\Roman{ownpublicationsenumi}: \citetitleverbatim{#2}}{Paper~\Roman{ownpublicationsenumi}}}% CHANGE added texorpdfstring to fix hyperref linking. % section-like line in ToC, but does not appear in main text body
\IfNoValueTF {#4}%
    { \IfNoValueTF {#5}% No value for #4, then check #5.
        {\partlike[\MakeUppercase{Paper~\Roman{ownpublicationsenumi}}]{\citetitleuppercase{#2}}}
        {\partlike[\MakeUppercase{Paper~\Roman{ownpublicationsenumi}}]{\citetitleuppercase{#2}}[\fullcite{#2} #5]}
    }%
    { \IfNoValueTF {#5}% Value for #4, then check #5.
        {\partlike[\MakeUppercase{Paper~\Roman{ownpublicationsenumi}}]{\citetitleuppercase{#2}}[\fullcite{#2} #5]}
        {\partlike[\MakeUppercase{Paper~\Roman{ownpublicationsenumi}}]{\citetitleuppercase{#2}}[#4 \fullcite{#2} #5]}
    }% nice purple page with article's title, like special page for parts, but does not appear in ToC and does not try to make it uppercase
\nopagecolor
\ifthenelse{\equal{#3}{}}%
{
\newpage
}
{
	\ifthenelse{\boolean{@isfinal}}{%
		\newgeometry{margin=0cm}%
		\includepdf[#1,noautoscale,clip=true]{#3}% include article's PDF, but scale it to fit the smaller pages' size
		\restoregeometry%
	}{%
		\includepdf[#1,frame=true]{#3}% include article's PDF, but keep author's scaling intact
	}
	}%
}

\newenvironment{fullarticles}[1][Previously Published Articles]{%
\markboth{}{}% no page header
\isdissertation{\cleardoublepage}{\clearpage}
\phantomsection
\part*{Previously Published Articles}
\addcontentsline{toc}{part}{\texorpdfstring{\MakeUppercase{#1}}{#1}}% part-like line in ToC, but does not appear in main text body
}{%
\isdissertation{\cleardoublepage}{\clearpage}
}
